name: CI/CD Pipeline

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  # ì½”ë“œ ê²€ì¦ ì‘ì—…
  code-validation:
    name: ì½”ë“œ ê²€ì¦
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: Python ì„¤ì •
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install black flake8 mypy  # ì½”ë“œ í’ˆì§ˆ ë„êµ¬
    
    - name: Python ë¬¸ë²• ê²€ì‚¬
      run: |
        echo "ğŸ” Python ë¬¸ë²• ê²€ì‚¬ ì¤‘..."
        python -m py_compile src/server.py
        find src -name "*.py" -exec python -m py_compile {} \;
        echo "âœ… ë¬¸ë²• ê²€ì‚¬ í†µê³¼"
    
    - name: Import ê²€ì‚¬
      run: |
        echo "ğŸ” Import ê²€ì‚¬ ì¤‘..."
        python -c "import sys; sys.path.insert(0, 'src'); from server import app; print('âœ… Import ê²€ì‚¬ í†µê³¼')"
        python -c "import sys; sys.path.insert(0, 'src'); from core.workflow import build_suno_request; print('âœ… Core ëª¨ë“ˆ Import í†µê³¼')"
        python -c "import sys; sys.path.insert(0, 'src'); from rag.orchestrator import Orchestrator; print('âœ… RAG ëª¨ë“ˆ Import í†µê³¼')"
    
    - name: ì½”ë“œ í¬ë§·íŒ… ê²€ì‚¬ (Black)
      continue-on-error: true
      run: |
        echo "ğŸ” ì½”ë“œ í¬ë§·íŒ… ê²€ì‚¬ ì¤‘..."
        black --check src/ || echo "âš ï¸ ì½”ë“œ í¬ë§·íŒ… ì´ìŠˆ ë°œê²¬ (ê²½ê³ ë§Œ í‘œì‹œ)"
    
    - name: ë¦°í„° ê²€ì‚¬ (Flake8)
      continue-on-error: true
      run: |
        echo "ğŸ” ë¦°í„° ê²€ì‚¬ ì¤‘..."
        flake8 src/ --max-line-length=120 --ignore=E501,W503 || echo "âš ï¸ ë¦°í„° ì´ìŠˆ ë°œê²¬ (ê²½ê³ ë§Œ í‘œì‹œ)"

  # Docker ë¹Œë“œ í…ŒìŠ¤íŠ¸
  docker-build:
    name: Docker ì´ë¯¸ì§€ ë¹Œë“œ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ
      run: |
        echo "ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
        docker build -t melody-learning:test .
        echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ì„±ê³µ"
    
    - name: Docker ì´ë¯¸ì§€ ê²€ì¦
      run: |
        echo "ğŸ” Docker ì´ë¯¸ì§€ ê²€ì¦ ì¤‘..."
        docker run --rm melody-learning:test python --version
        docker run --rm melody-learning:test pip list | grep -E "(fastapi|uvicorn|openai)"
        echo "âœ… Docker ì´ë¯¸ì§€ ê²€ì¦ ì™„ë£Œ"

  # FastAPI ì„œë²„ ì‹œì‘ í…ŒìŠ¤íŠ¸
  server-test:
    name: FastAPI ì„œë²„ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: [code-validation, docker-build]
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ
      run: docker build -t melody-learning:test .
    
    - name: ì„œë²„ ì‹œì‘ í…ŒìŠ¤íŠ¸
      run: |
        echo "ğŸš€ FastAPI ì„œë²„ ì‹œì‘ í…ŒìŠ¤íŠ¸ ì¤‘..."
        # ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì„œë²„ ì‹œì‘
        docker run -d --name test-server \
          -p 8000:8000 \
          -e OPENAI_API_KEY=test_key \
          -e SUNO_API_KEY=test_key \
          melody-learning:test
        
        # ì„œë²„ê°€ ì‹œì‘ë  ë•Œê¹Œì§€ ëŒ€ê¸°
        echo "â³ ì„œë²„ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
        sleep 10
        
        # í—¬ìŠ¤ ì²´í¬
        curl -f http://localhost:8000/health || echo "âš ï¸ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨ (API í‚¤ ì—†ì–´ì„œ ì •ìƒì¼ ìˆ˜ ìˆìŒ)"
        
        # API ë¬¸ì„œ ì—”ë“œí¬ì¸íŠ¸ í™•ì¸
        curl -f http://localhost:8000/docs || echo "âš ï¸ Docs ì—”ë“œí¬ì¸íŠ¸ í™•ì¸ ì‹¤íŒ¨"
        
        # ì„œë²„ ì¤‘ì§€
        docker stop test-server
        docker rm test-server
        echo "âœ… ì„œë²„ ì‹œì‘ í…ŒìŠ¤íŠ¸ ì™„ë£Œ"

  # ë°°í¬ ì‘ì—… (ìˆ˜ë™ íŠ¸ë¦¬ê±° ë˜ëŠ” main ë¸Œëœì¹˜ì—ë§Œ)
  deploy:
    name: ë°°í¬ ì¤€ë¹„
    runs-on: ubuntu-latest
    needs: [code-validation, docker-build, server-test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ
      run: |
        echo "ğŸ³ ë°°í¬ìš© Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
        docker build -t melody-learning:latest .
        echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"
    
    - name: ë°°í¬ ì¤€ë¹„ ì™„ë£Œ
      run: |
        echo "âœ… ëª¨ë“  ê²€ì¦ í†µê³¼!"
        echo "ğŸš€ Railwayì—ì„œ ìë™ ë°°í¬ê°€ ì‹œì‘ë©ë‹ˆë‹¤ (GitHub ì—°ê²° ì‹œ)"
        echo "ë˜ëŠ” ìˆ˜ë™ìœ¼ë¡œ Railway ëŒ€ì‹œë³´ë“œì—ì„œ ë°°í¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."

